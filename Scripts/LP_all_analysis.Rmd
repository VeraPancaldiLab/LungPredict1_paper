---
title: "LP_analysis"
author: "Marcelo Hurtado"
date: "2024-08-03"
output: html_document
---
Set up environment
```{r setup, include=FALSE}
source("src/environment_set.R") #Load functions and packages
set.seed(123) #For reproducibility
```

Load data
```{r}
counts = read.csv("Counts_LungPredict.csv", row.names = 1) 
traitData = read.csv("ClinicalData_LungPredict.csv", row.names = 1)
```

Keep only ENSEMBL IDs
```{r}
m2 <- do.call(rbind, strsplit(rownames(counts), split="_", fixed = TRUE))
counts <- as.matrix(counts)
rownames(counts) = m2[,1]
```

Extract only coding genes
```{r}
library(biomaRt)

mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

gene_ids <- rownames(counts)

# Get gene type annotations
annotations <- getBM(attributes = c("ensembl_gene_id", "gene_biotype"), 
                     filters = "ensembl_gene_id", 
                     values = gene_ids, 
                     mart = mart)

# Filter annotations to keep only coding genes
coding_genes <- annotations %>%
  filter(gene_biotype == "protein_coding") %>%
  pull(ensembl_gene_id)
 
# Subset the count matrix to keep only coding genes
counts <- counts[rownames(counts) %in% coding_genes, ]
```

Change to SYMBOL
```{r}
# Extract gene symbols 
entrz <- AnnotationDbi::select(org.Hs.eg.db, keys = rownames(counts), columns = "SYMBOL", keytype = "ENSEMBL") 

# Choose first gene symbol whenever one ENSEMBL ID have multiple Gene SYMBOLS
entrz <- entrz %>%
  group_by(ENSEMBL) %>%
  slice(1) %>%
  ungroup()

# Final count matrix
counts = counts %>%
  data.frame() %>%
  mutate(Genes_symbol = entrz$SYMBOL) %>%
  na.omit(.) %>% #Remove genes with NO gene symbol
  remove_rownames() %>%
  distinct(Genes_symbol, .keep_all = TRUE) %>% #Keep only first gene symbol if duplicated
  column_to_rownames("Genes_symbol") 

```

Data normalization (if needed)
```{r}
counts.norm = ADImpute::NormalizeTPM(counts, log=T) 
```

Deconvolution

- Perform deconvolution using 6 methods and 10 signatures (GEMDeCan). It needs as input raw counts (genes as SYMBOL) and it will ask for your credentials to run CBSX
```{r}
deconv = compute.deconvolution(counts.norm, normalized = F, credentials.mail = "marcelo.hurtado@inserm.fr", credentials.token = "734212f6ad77fc4eea2bdb502792f294")
```

TFs activity inference
```{r}
tfs = compute.TFs.activity(counts.norm)
```

TFs network construction
```{r}
network = compute.WTCNA(tfs, corr_mod = 0.9, clustering.method = "ward.D2", minMod = 50) 
#Association of TFs modules with clinical data
compute.metada.association(network[[1]], traitData, pval = 0.05, width = 10) 
```

Pathways activity inference
```{r}
pathways = compute.pathway.activity(counts.norm)
#Association of TFs modules with pathways
compute.modules.relationship(network[[1]], pathways, "Pathways_Progeny-TFs_Modules", height = 6, width = 9, vertical = T)
```

Deconvolution analysis
```{r}
dt = compute.deconvolution.analysis(deconv, corr = 0.7, seed = 123) #seed is restart inside, so it is important to set seed again here to ensure reproducibility
#Association of TFs modules with deconvolution 
compute.modules.relationship(network[[1]], dt[[1]], "Deconvolution-TFs_Modules", vertical = T, height = 30, width = 10, pval = 0.05)
```

Immunoscores calculation
```{r}
source("src/immunoscores.R")
gold.standards <- compute_gold_standards(RNA.tpm = data.frame(counts.norm))
```

Heatmap annotations
```{r}
annotations = cbind(traitData, gold.standards)

heatmap_annotation = function(annotations){
  require(circlize)
  greyscale <- grey.colors(10, rev = T)
  col_fun = colorRamp2(c(0, 0.5, 1), c(brewer.pal(9, "YlOrBr")[1], brewer.pal(9, "YlOrBr")[4], brewer.pal(9, "YlOrBr")[9]))
  
  ann_colors <- HeatmapAnnotation(
    Stage = annotations$Stages_simplified, 
    Sex = annotations$Gender,
    CYT = annotations$CYT,
    Roh_IS = annotations$Roh_IS,
    Davoli_IS = annotations$Davoli_IS,
    IFNy = annotations$IFNy,
    Ayers_expIS = annotations$Ayers_expIS,
    Tcell_inflamed = annotations$Tcell_inflamed,
    
    col = list(
      Stage = c("I" = greyscale[1], "II" = greyscale[4], "III" = greyscale[7], "IV" = greyscale[10]),
      Sex = c("M" = "blue", "F" = "red"),
      CYT = col_fun,
      Roh_IS = col_fun,
      Davoli_IS = col_fun,
      IFNy = col_fun,
      Ayers_expIS = col_fun,
      Tcell_inflamed = col_fun
    ),
    
    annotation_legend_param = list(labels_gp = gpar(fontsize = 10), legend_width = unit(12, "cm"), 
                                   legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12))
    
  )
  
  return(ann_colors)
  
}
```

Heatmap of deconvolution + TFs 
```{r}
dend_column = as.dendrogram(hclust(dist(dt[[1]]), method = "ward.D2"))

ha = heatmap_annotation(annotations)

ht1 = Heatmap(t(scale(dt[[1]])), 
        border = T, cluster_columns = dend_column, column_split = 3, 
        top_annotation = ha, column_gap = unit(8, "mm"), 
        name = "Deconvolution", clustering_method_rows = "ward.D2", 
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(30, "cm"), height = unit(50, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))


pdf("Results/Heatmap_deconvolution", width = 30, height = 28)
draw(ht1, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```

TFs modules + pathways
```{r}
ht2 = Heatmap(t(scale(network[[1]])), 
        border = T, cluster_columns = dend_column,  name = "TFs modules",
        column_gap = unit(8, "mm"), clustering_method_rows = "ward.D2", 
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(25, "cm"), height = unit(4, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

ht3 = Heatmap(t(scale(pathways)), 
        border = T, cluster_columns = dend_column,name = "Pathways scores",
        column_gap = unit(8, "mm"), clustering_method_rows = "ward.D2", 
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(25, "cm"), height = unit(8, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

pdf("Results/Heatmap_TFs_modules", width = 20, height = 10)
draw(ht2%v%ht3, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```

Cluster identification
```{r}
library(factoextra)
pdf("Results/Dendrogram_samples", width = 14, height = 8)
par(mar = c(5, 1, 1, 1)) #bottom, left, top, right
plot(dend_column)
dendextend::rect.dendrogram(dend_column, k=3, border = 2:5)
dev.off()
```

Feature selection
```{r}
data = dt[[1]] %>%
  mutate(target = cutree(dend_column, k = 3))

deconvolution_selected = feature.selection.boruta(data, iterations = 100, file_name = "All_stages", thres = 0.9)
```

Heatmap of selected deconvolution features
```{r}
boruta_groups = dt[[1]][,colnames(dt[[1]])%in%deconvolution_selected$Confirmed]

ht1 = Heatmap(t(scale(boruta_groups)), row_split = 3,
        border = T, cluster_columns = dend_column, column_split = 3, row_gap = unit(5, "mm"), 
        top_annotation = heatmap_annotation(annotations), column_gap = unit(8, "mm"), 
        name = "Deconvolution", clustering_method_rows = "ward.D2", clustering_method_columns = "ward.D2",
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(25, "cm"), height = unit(15, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

ht2 = Heatmap(t(scale(network[[1]])), 
        border = T, cluster_columns = dend_column,  
        column_gap = unit(8, "mm"), clustering_method_rows = "ward.D2", 
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(25, "cm"), height = unit(4, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

ht3 = Heatmap(t(scale(pathways)), 
        border = T, cluster_columns = dend_column,  
        column_gap = unit(8, "mm"), clustering_method_rows = "ward.D2", 
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(25, "cm"), height = unit(8, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

pdf("Results/Heatmap_deconvolution_boruta", width = 25, height = 12)
draw(ht1, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```

================================================================================================================================

Data integration pipeline

Identify cell groups from significant deconvolution features across TFs modules
```{r}
corr_modules = compute.modules.relationship(network[[1]], dt[[1]], return = T)
tfs.modules.clusters = compute.TF.network.classification(network, pathways)
cell_dendrograms = identify.cell.groups(corr_modules, tfs.modules.clusters, height = 20) 
```

Perform cell groups analysis 
```{r}
res_all = cell.groups.analysis(dt[[1]], tfs.module.network = network, cell.dendrograms = cell_dendrograms, cut.height = 5, height = 20)
```

Features annotations
```{r}
module_colors = paste0("(", paste(unique(network[[2]]), collapse = "|"), ")")
  
dendrograms_colors <- sapply(colnames(res_all[[1]]), function(x) {
  match <- regexpr(module_colors, x)
  if (match != -1) {
    return(regmatches(x, match))
  } else {
    return(NA)
  }
})

features_annot = res_all[[1]] %>%
  t() %>%
  data.frame() %>%
  mutate(Color = paste0("TF_", dendrograms_colors))

row_annot <- rowAnnotation(Modules = features_annot$Color, 
                           
                           col = list(Modules = c("TF_blue" = "blue", "TF_turquoise" = "turquoise", "TF_yellow" = "yellow", "TF_brown" = "brown",
                                                  "TF_black" = "black", "TF_green" = "green", "TF_pink" = "pink")),
                           
                           annotation_legend_param = list(labels_gp = gpar(fontsize = 10), legend_width = unit(12, "cm"), 
                                                          legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

```

Heatmap of cell groups
```{r}
hc = hclust(dist(res_all[[1]]), method = "ward.D2")
dend_column = as.dendrogram(hc)

ht1 = Heatmap(t(scale(res_all[[1]])), 
        border = T, cluster_columns = dend_column,   
        top_annotation = ha, column_gap = unit(8, "mm"), #right_annotation = row_annot,
        name = "Cell groups", clustering_method_rows = "ward.D2", 
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(25, "cm"), height = unit(15, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

pdf("Results/Heatmap_cell_groups", width = 25, height = 12)
draw(ht1, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```

Patient classification
```{r}
sub_grp <- cutree(hc, k = 2)
plot(dend_column, cex = 0.6)
rect.hclust(hc, k = 2, border = 2:5)
```

Feature selection
```{r}
data = res_all[[1]] %>%
  mutate(target = sub_grp)

cell_groups_selected = feature.selection.boruta(data, iterations = 100, file_name = "All_stages_cell_groups", thres = 0.9)
```

Heatmap of selected cell groups
```{r}
boruta_groups = res_all[[1]][,colnames(res_all[[1]])%in%cell_groups_selected$Confirmed]

hc2 = hclust(dist(t(boruta_groups)), method = "ward.D2")
dend_row = as.dendrogram(hc2)

ht1 = Heatmap(t(scale(boruta_groups)), 
        border = T, cluster_columns = dend_column, cluster_rows = dend_row,   
        column_gap = unit(8, "mm"), top_annotation = heatmap_annotation(annotations), 
        name = "Cell groups", clustering_method_rows = "ward.D2", 
        column_dend_height = unit(5, "cm"), row_dend_width = unit(5, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(25, "cm"), height = unit(10, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

pdf("Results/Heatmap_cell_groups_boruta", width = 25, height = 12)
draw(ht1, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```

Extract cell types per cluster
```{r}
par(mar = c(15, 2, 1, 4)) #bottom, left, top, right
plot(dend_row, cex = 0.6)
rect.hclust(hc2, k = 2, border = 2:5)

cell_subgr <- cutree(hc2, k = 2)

for (clust in 1:length(unique(cell_subgr))) {
  cells_clust = unique(unlist(unname(res_all[[2]][which(cell_subgr == clust)])))
  cells_names_cluster = extract_cells(cells_clust)
  print(cells_names_cluster)
  print("====================================================================")
}
```

PCA analysis 
```{r}
#PCA
fviz_cluster(list(data = boruta_groups, cluster = sub_grp))

#Biplot
res.pca <- prcomp(boruta_groups,  scale = F)
fviz_pca_biplot(res.pca, label="var", habillage=sub_grp, select.var = list(contrib = 4),
               addEllipses=TRUE, ellipse.level=0.75)

# Extract the loadings
loadings <- res.pca$rotation
contribution <- (loadings^2)*100
features = contribution %>%
  data.frame() %>%
  rownames_to_column("Features") %>%
  arrange(desc(PC1)) 

print(features)

pdf("Results/Cell_groups_contribution_pca.pdf", width = 12, height = 8)
p = ggplot(features, aes(x = reorder(Features, -PC1), y = PC1)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Contribution of cell groups",
       x = "Feature",
       y = "Contribution (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size=12))
print(p)
dev.off()
```

Check cell group composition of most important features
```{r}
top = 3
for (i in 1:top) {
  print(res_all[[2]][features$Features[i]])
  print("========================================================================")
}
```